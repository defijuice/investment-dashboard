# amount-update 스킬 가이드

## 이 스킬은 무엇을 하나요?

**한 줄 요약**: 선정결과 PDF 파일을 읽어서, 이미 등록된 신청현황 중 '선정' 상태인 항목들의 금액 필드(최소결성규모, 모태출자액, 결성예정액, 출자요청액)를 자동으로 채워줍니다.

## 왜 필요한가요?

**문제 상황**:
1. `/update` 스킬로 PDF를 처리하면 출자사업, 운용사, 신청현황이 자동으로 등록됩니다
2. 하지만 **금액 필드는 비어있습니다** (PDF 파싱 시 금액까지 한 번에 추출하기 어려워서)
3. 수동으로 100~200개 항목의 금액을 입력하려면 **몇 시간**이 걸립니다

**해결책**:
- `amount-update` 스킬을 실행하면 선정결과 PDF를 다시 읽어서 금액만 자동 추출하여 업데이트합니다
- 수백 건도 **단 몇 초**만에 처리됩니다

## 언제 사용하나요?

```text
/update로 PDF 처리 완료
    ↓
신청현황 생성됨 (금액 필드 빈칸)
    ↓
/amount-update 실행  ← 여기!
    ↓
금액 필드 자동 채워짐
```

## 사용 방법

```bash
/amount-update
```

실행 시 프롬프트에 따라 **파일번호** 또는 **출자사업ID**를 입력합니다:

```bash
파일번호를 입력하세요 (예: 4444): 4445
또는
출자사업ID를 입력하세요 (예: PJ0020): PJ0020
```

## 어떻게 작동하나요?

### 전체 흐름

```text
1. 입력값 받기
   ├─ 파일번호 (예: 4445) 입력 시 → 해당 파일에 연결된 출자사업 자동 찾기
   └─ 출자사업ID (예: PJ0020) 입력 시 → 해당 사업의 선정결과 파일 자동 찾기

2. PDF 파일 찾기
   └─ downloads/4445_한국모태펀드_중기부_2024년_1차_선정결과.pdf

3. PDF 파싱 (Claude AI가 직접 읽음)
   ├─ 표 형식 감지 (Type A/B/C)
   ├─ 운용사명, 출자분야, 금액 추출
   └─ 병합 셀(공동GP) 자동 감지 → n분의 1 처리

4. Google Sheets 데이터 조회
   ├─ 신청현황: 선정 상태만 필터링
   ├─ 운용사: ID → 이름 매핑
   └─ 출자사업: 연결 정보 확인

5. 매칭 (운용사명 + 출자분야)
   ├─ PDF의 "다성벤처스 - 루키리그"
   └─ → 신청현황의 OP0042(다성벤처스) + "중진 - 루키리그"

6. 배치 업데이트 (한 번에)
   └─ Google Sheets에 최소결성규모, 모태출자액, 결성예정액, 출자요청액, 통화단위 저장
```

### 상세 단계별 설명

#### Step 1: 데이터 준비

스킬이 시작되면 다음 정보를 Google Sheets에서 가져옵니다:

- **출자사업**: 어떤 사업에 어떤 파일이 연결되어 있는지
- **파일**: 파일번호로 실제 파일명 찾기
- **운용사**: ID를 이름으로 변환 (OP0042 → 다성벤처스)
- **신청현황**: 선정 상태인 항목만 필터링

#### Step 2: PDF 분석

PDF를 읽어서 표 데이터를 추출합니다. PDF 형식은 출자사업마다 다릅니다:

**Type A** (중기부 정시):
```
| 최소결성규모 | 모태출자액 | 운용사명 |
|-------------|-----------|---------|
| 200         | 100       | 다성벤처스 |
```

**Type B** (문체부, 환경부):
```
| 결성예정액 | 출자요청액 | 운용사명 |
|-----------|-----------|---------|
| 500       | 300       | 케이넷투자파트너스 |
```

**Type C** (4개 필드 모두 있음):
```
| 최소결성규모 | 모태출자액 | 결성예정액 | 출자요청액 | 운용사명 |
```

#### Step 3: 병합 셀 처리 (핵심 기능!)

PDF에서 여러 운용사가 하나의 금액을 공유하는 경우가 있습니다:

**예시**: 문체부 2024년 1차 - IP 분야
```
| 결성예정액 | 출자요청액 | 운용사명 |
|-----------|-----------|---------|
| 1500      | 900       | 스마트스터디벤처스 |
|           |           | 에이비즈파트너스 |
|           |           | 디에이밸류인베스트먼트 |
|           |           | 유티씨인베스트먼트 |
|           |           | 솔트룩스벤처스 |
```

위 표는 **병합 셀** 형태로 5개 운용사가 1500억/900억을 공유하고 있습니다.

**자동 처리 방식**:
1. 5개 운용사 감지
2. 금액을 5로 나눔: 1500 ÷ 5 = 300억, 900 ÷ 5 = 180억
3. 각 운용사에 동일한 금액 저장
4. 비고란에 원본 정보 기록:
   ```
   병합: 결성예정액 1500억, 출자요청액 900억 (5사 공유)
   ```

#### Step 4: 매칭

PDF에서 추출한 데이터와 Google Sheets의 신청현황을 매칭합니다.

**매칭 기준**:
- 운용사명 일치 (정규화 후 비교)
- 출자분야 일치

**정규화 규칙**:
```javascript
"다성벤처스㈜" → "다성벤처스"
"주식회사 IBK캐피탈" → "ibk캐피탈"
```

**예시**:
```
PDF: 다성벤처스, 루키리그, 최소결성규모 200억, 모태출자액 100억
  ↓ 매칭
신청현황: OP0042(다성벤처스), 중진 - 루키리그, 상태: 선정
  ↓ 결과
신청현황 row에 200억, 100억 입력
```

#### Step 5: 배치 업데이트

매칭된 모든 항목을 **한 번에** 업데이트합니다 (API 호출 최소화).

**업데이트 필드** (신청현황 시트 E~J열):
- E: 최소결성규모
- F: 모태출자액
- G: 결성예정액
- H: 출자요청액
- I: 통화단위 (`억원` 또는 `USD(M)`)
- J: 비고 (병합 정보 등)

## 금액 저장 형식

모든 금액은 **억원/M 단위 숫자**로 저장됩니다 (원화 변환 없음):

**원화**:
- PDF: `300억원` → 저장: `300`, 통화단위: `억원`
- PDF: `243.35억` → 저장: `243.35`, 통화단위: `억원`

**달러**:
- PDF: `USD 50M` → 저장: `50`, 통화단위: `USD(M)`

## 실행 결과 예시

```text
=== 금액 배치 업데이트 시작 ===

출자사업 ID: PJ0020
→ 선정결과 파일: 중기부_2024년_1차_정시_선정결과.pdf (4445)

=== PDF 파싱 시작: 4445_중기부_2024년_1차_정시_선정결과.pdf ===
Type: A
통화: 억원
총 38건 로드

=== 매칭 시작 ===
선정 상태 신청현황: 38건
PDF 파싱 데이터: 38건

  ✓ 다성벤처스 → row 45
  ✓ 바인벤처스 → row 46
  ✓ 세이지원파트너스 → row 47
  ...
  ✓ 피앤피인베스트먼트 → row 62 [병합: 2사]
  ✓ 파이오니어인베스트먼트 → row 63 [병합: 2사]
  ...

=== 매칭 결과 ===
매칭 성공: 38건
매칭 실패 (PDF): 0건

=== 배치 업데이트 실행 (38건) ===
✓ 38건 업데이트 완료
  (병합 처리: 4건)
    - 2사 공유: 4건

=== 완료 ===
```

## 주의사항

### 1. 선정 상태만 업데이트

- **선정결과 파일**의 금액만 추출하기 때문에
- **선정 상태**인 신청현황만 업데이트됩니다
- 탈락한 운용사는 금액이 비어있어도 정상입니다 (접수현황 파일에는 금액 정보가 없음)

### 2. 매칭 실패 시

운용사명이 PDF와 DB에서 다르게 표기된 경우 매칭 실패할 수 있습니다:

```text
✗ IBK캐피탈 (중진 - 루키리그) - 매칭 실패
```

**원인**:
- DB: "아이비케이캐피탈"
- PDF: "IBK캐피탈"

**해결 방법**:
- 운용사 시트의 **약어** 필드에 다른 표기법 추가
- 예: 약어란에 `IBK캐피탈` 추가

### 3. 공동GP 처리

PDF에 "피앤피/파이오니어"로 표기된 경우:

**처리 순서**:
1. `/update` 스킬 실행 시 이미 2개 행으로 분리되어 저장됨
   - 피앤피인베스트먼트 (row 62)
   - 파이오니어인베스트먼트 (row 63)

2. `/amount-update` 실행 시:
   - 병합 감지 (2개 운용사)
   - 금액을 2로 나눔: 160 ÷ 2 = 80억
   - 각 행에 80억씩 저장
   - 비고란에 "병합: 최소결성규모 160억, 모태출자액 80억 (2사 공유)" 추가

### 4. 이미 입력된 금액도 덮어씁니다

재실행 시 기존 금액이 있어도 **덮어쓰기**됩니다.

### 5. PDF 표 형식이 사업마다 다름

- Type A (최소결성규모, 모태출자액): 중기부 정시
- Type B (결성예정액, 출자요청액): 문체부, 환경부 등
- Type C (4개 필드 모두): 일부 사업

스킬이 자동으로 감지하여 처리합니다.

## 트러블슈팅

### Q1: "파일을 찾을 수 없습니다" 에러

**원인**: PDF 파일이 `downloads/` 폴더에 없음

**해결**:
1. KVIC 공지사항 페이지에서 해당 파일 다운로드
2. `downloads/` 폴더에 저장
3. 파일명이 `파일번호_`로 시작하는지 확인 (예: `4445_한국모태펀드_중기부...pdf`)

### Q2: 매칭 실패가 많이 발생

**원인**: 운용사명 표기 불일치

**해결**:
1. 실패 로그 확인:
   ```
   ✗ IBK캐피탈 (중진 - 루키리그) - 매칭 실패
   ```
2. Google Sheets 운용사 시트에서 해당 운용사 찾기
3. 약어 필드에 PDF 표기법 추가 (예: `IBK캐피탈`)
4. 스킬 재실행

### Q3: 병합 정보가 비고란에 너무 길게 표시됨

**정상 동작**: 원본 금액과 운용사 수를 명시하여 투명성 확보

예시:
```
병합: 결성예정액 1500억, 출자요청액 900억 (5사 공유)
```

## 기술 세부사항

### 사용 기술

- **PDF 파싱**: `pdftotext` (poppler-utils) + Claude AI 직접 읽기
- **Google Sheets API**: `batchUpdate` (배치 업데이트)
- **매칭 알고리즘**: 정규화 + 부분 문자열 비교

### 성능

- **100건 업데이트**: 약 3초
- **API 호출**: 1회 (배치 업데이트)

### 관련 파일

- [src/utils/batch-amount-update.js](src/utils/batch-amount-update.js): 메인 로직
- [.claude/commands/amount-update.md](.claude/commands/amount-update.md): 상세 명세

## 요약

`/amount-update` 스킬은:
- 선정결과 PDF를 읽어서
- 선정된 신청현황의 금액 필드를 자동으로 채워주고
- 병합 셀도 자동으로 처리하며
- 단 몇 초만에 수백 건을 업데이트합니다

**사용 시점**: `/update`로 PDF 처리 완료 후, 금액 필드가 비어있을 때
