# KVIC 출자사업 자동화 전체 흐름 상세 분석 (v2)

이 문서는 2026년 1월 14일 기준 현재 개발된 코드의 실제 구현 상태를 분석한 결과입니다.

---

## 1. 전체 아키텍처 개요

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    KVIC 출자사업 자동화 파이프라인 v2                          │
└─────────────────────────────────────────────────────────────────────────────┘

Phase 1: 스크래핑 & 다운로드 (npm start)
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ KVIC 웹사이트 │────▶│ 공지 목록    │────▶│ 파일 다운로드 │────▶│ Google Drive │
│ 공지사항     │     │ 추출        │     │ (로컬)       │     │ 업로드       │
└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
                           │                   │                   │
                           ▼                   ▼                   ▼
                    processed.json       downloads/           파일 시트 등록

Phase 2: PDF 처리 (/update 커맨드) - 5단계 최적화 적용
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ 파일 쌍 찾기 │────▶│ 이중 파싱    │────▶│ 운용사 매칭  │────▶│ 검토/승인    │
│ (접수+선정) │     │ (AI+Python) │     │ 캐싱+배치   │     │ 워크플로우   │
└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
       │                   │                   │                   │
       ▼                   ▼                   ▼                   ▼
  파일DB 조회         pdfplumber +      operator-matcher    ReviewSession
                     Claude AI          9단계 유사도          y/n/e/r

Phase 3: 금액 업데이트 (/amount-update 커맨드)
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ 선정결과 PDF │────▶│ 금액 추출    │────▶│ 신청현황     │
│ 분석        │     │ 운용사 매칭  │     │ 금액 필드    │
└─────────────┘     └─────────────┘     └─────────────┘
       │                   │                   │
       ▼                   ▼                   ▼
  결과파일ID         병합 셀 처리           6개 금액 필드
  연결된 PDF          n분의1              batchUpdate

Phase 4: 검증 (/verify 커맨드)
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ PDF 재분석   │────▶│ DB 데이터    │────▶│ 교차 검증    │
│ pdfplumber  │     │ 비교        │     │ 리포트       │
└─────────────┘     └─────────────┘     └─────────────┘
       │                   │                   │
       ▼                   ▼                   ▼
  운용사 추출         신청현황 조회         확인완료 상태
```

---

## 2. 핵심 모듈 구조

### 2.1 파일 구조

```
src/
├── index.js                          # 스크래핑 메인 진입점
├── core/
│   ├── scraper.js                    # Puppeteer 기반 KVIC 스크래퍼
│   ├── googleDrive.js                # Google Drive OAuth & 업로드
│   └── googleSheets.js               # Google Sheets API 클라이언트 (★핵심)
├── processors/
│   ├── process-pair-sheets.js        # PDF 처리 메인 프로세서 (★핵심)
│   ├── pdf-parser.py                 # pdfplumber 기반 Python 파서
│   └── pdf-compare.js                # AI vs pdfplumber 비교 모듈
├── matchers/
│   ├── operator-matcher.js           # 운용사 유사도 매칭 (★핵심)
│   └── operator-audit.js             # 중복 운용사 병합 유틸
├── workflows/
│   ├── review-workflow.js            # 검토/승인 터미널 UI (★핵심)
│   ├── ai-verification.js            # AI 기반 데이터 검증
│   └── file-summary.js               # 파일 현황 계산
├── utils/
│   ├── checkpoint.js                 # 체크포인트 & 재시도 (★신규)
│   ├── normalize.js                  # 운용사명 정규화 (★신규)
│   ├── verify-operator-matching.js   # 운용사 매칭 검증
│   └── batch-amount-update.js        # 금액 배치 업데이트
└── verify-project.js                 # 검증 CLI 진입점
```

### 2.2 모듈 의존성 다이어그램

```
process-pair-sheets.js (메인 프로세서)
│
├── googleSheets.js (데이터 레이어)
│   ├── getAllRowsCached()      # Phase 2 캐싱
│   ├── createOperatorsBatch()  # Phase 1 배치
│   ├── createApplicationsBatch()
│   ├── updateRejectedStatus()  # Phase 5 탈락 처리
│   └── syncFileStatusWithApplications()
│
├── operator-matcher.js (매칭 엔진)
│   ├── findSimilarOperators()
│   └── calculateOperatorSimilarity()
│
├── review-workflow.js (UI 레이어)
│   ├── ReviewSession
│   └── prepareReviewData()
│
├── checkpoint.js (안정성 레이어)
│   ├── CheckpointManager
│   └── withRetry()
│
└── normalize.js (유틸리티)
    └── normalizeName()
```

---

## 3. Phase 2 상세: PDF 처리 (/update 커맨드)

### 3.1 전체 처리 흐름 (15단계)

```
/update {파일번호} 실행
    │
    ▼
╔═══════════════════════════════════════════════════════════════════════════╗
║ Phase A: 데이터 수집 (메모리 전용, DB 무변경)                                  ║
╠═══════════════════════════════════════════════════════════════════════════╣

    │
    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ [1] PDF 파싱 (이중 파싱)                                                   │
│ ├─ pdftotext → 텍스트 추출                                               │
│ ├─ Claude AI → 구조화 JSON 추출                                          │
│ │   ├─ parseApplicationPdfWithAI() - 접수현황                            │
│ │   └─ parseSelectionPdfWithAI() - 선정결과                              │
│ ├─ pdfplumber → 표 구조 추출 (Python)                                    │
│ │   └─ python3 src/processors/pdf-parser.py <파일경로> [--selection]      │
│ └─ 결과 비교: 일치/충돌/한쪽만 존재                                        │
│                                                                          │
│ 비교 규칙:                                                                │
│ ├─ 일치 → 자동 진행                                                      │
│ ├─ Claude만 발견 → 포함 (정확도 높음)                                     │
│ ├─ pdfplumber만 발견 → 스킵 (노이즈 가능성)                               │
│ └─ 공동GP 판단 충돌 → ⚠️ 사용자에게 반드시 질문                            │
└─────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ [2] 캐싱 로드 (Phase 2 최적화) - API 호출 60-70% 감소                       │
│ ├─ sheets.getAllRowsCached('운용사')                                     │
│ │   └─ 전체 운용사 1회 로드, 5분 TTL 캐시                                 │
│ ├─ sheets.getAllRowsCached('신청현황')                                   │
│ │   └─ 중복 조회 방지                                                    │
│ └─ 약어 맵 구성 (API 호출 없이 메모리 조회)                                │
│     └─ aliasMap: Map<약어 → operatorId>                                 │
└─────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ [3] 출자사업 메타데이터 확인 (저장 안함)                                     │
│ ├─ PDF에서 사업명 추출                                                   │
│ ├─ 기존 출자사업 존재 여부 확인                                           │
│ └─ 신규 여부 플래그 설정                                                  │
└─────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ [4] 파일 DB 상태 확인                                                     │
│ ├─ 파일번호로 파일 시트 조회                                              │
│ ├─ 파일유형 (접수현황/선정결과) 확인                                       │
│ └─ 처리상태 확인 (완료/미처리)                                            │
└─────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ [5] 기존 신청현황 Map 구성                                                │
│ ├─ 해당 출자사업의 기존 신청현황 조회                                      │
│ └─ 중복 키 생성: `${operatorId}|${category}`                            │
│     예: "OP0001|중진 - 루키리그"                                         │
│                                                                          │
│ ⚠️ 주의: 운용사ID만으로 중복 체크하면 안됨!                                 │
│    같은 운용사가 다른 분야에 신청 가능                                      │
└─────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ [5.5] 신규 운용사 유사도 검토 (★핵심 단계)                                  │
│ ├─ findSimilarOperators(newNames, existingOperators, 0.6)              │
│ │                                                                       │
│ │ 9단계 유사도 계산:                                                     │
│ │ 1. 정확히 일치 → score: 1.0, 자동 사용                                 │
│ │ 2. 정규화 후 일치 → score: 0.98, 자동 사용                             │
│ │ 3. 약어 일치 → 자동 사용                                               │
│ │ 4. 접미사 제거 후 일치 → score: 0.95                                   │
│ │    접미사: 인베스트먼트, 벤처스, 파트너스, 캐피탈, LLC 등               │
│ │ 5. 한글 자모 분해 비교 → score: jamoSim × 0.9                         │
│ │ 6. 초성 비교 → score: choSim × 0.7                                   │
│ │ 7. 영문↔한글 약어 양방향 매칭 → score: 0.85                           │
│ │    KB↔케이비, IBK↔아이비케이, BNK↔비엔케이                           │
│ │ 8. 부분 문자열 포함 → score: 0.7 + ratio × 0.25                      │
│ │ 9. 일반 문자열 유사도 (Levenshtein)                                   │
│ │                                                                       │
│ │ 자동 판정 규칙:                                                        │
│ │ ├─ 85% 미만 → 신규 등록 (자동)                                        │
│ │ ├─ 85% 이상 & 핵심명 60% 미만 → 신규 (접미사만 유사)                   │
│ │ └─ 85% 이상 & 핵심명 60% 이상 → ⚠️ 사용자 확인                        │
│ │                                                                       │
│ └─ 분류 결과:                                                            │
│     ├─ exact: 정확 일치 (기존 ID 사용)                                   │
│     ├─ similar: 사용자 확인 필요                                         │
│     └─ new: 완전 신규 (등록 예정)                                        │
└─────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ [6] 운용사 매핑 준비 (메모리)                                              │
│ ├─ 접수파일 + 선정결과파일 운용사 통합                                     │
│ ├─ operatorMappings: Map<운용사명 → {id, name, isNew, originalName}>    │
│ └─ pendingNewOperators: 신규 등록 예정 운용사 목록                         │
└─────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ [6.5] enrichedApplicants 준비                                            │
│ ├─ applicants 배열에 선정/탈락 상태 추가                                  │
│ ├─ operatorId 할당 (PENDING = 아직 미할당)                               │
│ ├─ 선정 판별: selectedNames Set에서 정규화 후 검색                        │
│ │   └─ normalizeName(name) + alias 확장                                 │
│ └─ 중복 플래그 설정: isDuplicate, willSkip                               │
└─────────────────────────────────────────────────────────────────────────┘
    │
    ▼
╠═══════════════════════════════════════════════════════════════════════════╣
║ Phase B: 검토 → 승인 → 일괄 저장                                            ║
╠═══════════════════════════════════════════════════════════════════════════╣
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ [7] 검토 화면 (ReviewSession)                                             │
│ ├─ 요약: PDF 기재 건수 vs 실제 처리 예정                                  │
│ ├─ 신규 운용사 목록                                                       │
│ ├─ 중복 스킵 항목                                                         │
│ ├─ 공동GP 분리 결과                                                       │
│ └─ 전체 신청현황 테이블                                                   │
│                                                                          │
│ 명령어:                                                                   │
│ ├─ y: 승인 후 저장                                                       │
│ ├─ n: 취소 (저장 안함)                                                   │
│ ├─ e: 항목 수정 (운용사명, 출자분야, 상태)                                 │
│ ├─ r: 리포트 다시 보기                                                    │
│ └─ s: 요약만 보기                                                         │
└─────────────────────────────────────────────────────────────────────────┘
    │
    ▼ (y 승인 시)
┌─────────────────────────────────────────────────────────────────────────┐
│ [8] 출자사업 생성/조회                                                    │
│ ├─ sheets.getOrCreateProject(projectName, metadata)                     │
│ └─ { isNew, id, data } 반환                                             │
└─────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ [9] 파일 DB 생성 및 출자사업 연결                                          │
│ ├─ sheets.getOrCreateFileHistory(fileNo, fileName, fileType)            │
│ ├─ sheets.updateProjectFileId(projectId, fileType, fileId)              │
│ │   └─ ⚠️ DUPLICATE_FILE_LINK 에러 시 처리 중단                          │
│ └─ 지원파일ID 또는 결과파일ID에 연결                                       │
└─────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ [10] 운용사 배치 생성 (Phase 1 최적화) - API 1회                           │
│ ├─ sheets.createOperatorsBatch(pendingNewOperators)                     │
│ └─ 반환: Map<운용사명 → ID>                                              │
│                                                                          │
│ 성능: 200건 → 기존 400초 → 현재 5초                                       │
└─────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ [11] 신청현황 배치 생성 (Phase 1 최적화) - API 1회                          │
│ ├─ sheets.createApplicationsBatch(applicationsToCreate)                 │
│ │   [{출자사업ID, 운용사ID, 출자분야, 상태, 비고}, ...]                    │
│ └─ 상태: 접수파일 → '접수', 선정파일 → '선정'/'탈락'                       │
│                                                                          │
│ ⚠️ 중복 스킵: existingKey = `${operatorId}|${category}`                  │
└─────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ [11-2] 누락된 선정 운용사 확인 (선정파일만)                                  │
│ ├─ 선정 PDF에 있지만 기존 신청현황에 없는 운용사 감지                       │
│ └─ 경고 로그 출력 또는 신규 추가                                          │
└─────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ [12] 약어 배치 업데이트                                                   │
│ ├─ 유사도 매칭으로 발견된 다른 표기법 수집                                 │
│ │   예: 기존 "IBK벤처투자" + 파싱 "아이비케이벤처투자"                     │
│ └─ sheets.updateOperatorAliasesBatch(aliasUpdates)                      │
│                                                                          │
│ ⚠️ 현재는 개별 API 호출 (개선 대상)                                       │
└─────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ [13] 파일 DB 상태 업데이트                                                │
│ ├─ 처리상태: '완료'                                                       │
│ ├─ 처리일시: 현재 타임스탬프                                               │
│ └─ 현황: 신청현황 테이블에서 계산                                          │
│                                                                          │
│ 현황 형식 (★신청현황에서 계산):                                            │
│ ├─ 접수: "신청조합 171개, 공동GP 12개(...), 총 신청현황 165건"            │
│ └─ 선정: "총 165개 중 선정 45건"                                          │
└─────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ [14] 출자사업 현황 통계 재계산                                             │
│ ├─ sheets.updateProjectStatus(projectId)                                │
│ └─ 현황: "총 171건 (선정 45, 탈락 126)"                                   │
│     신청현황 테이블에서 자동 집계                                          │
└─────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ [15] 탈락 상태 업데이트 (Phase 5) - 선정파일 처리 시                        │
│ ├─ sheets.updateRejectedStatus(projectId, selectedOperatorIds)          │
│ │   └─ 선정 명단에 없는 "접수" → "탈락"으로 변경                           │
│ └─ 배치 업데이트 사용                                                     │
│                                                                          │
│ 예: 170건 접수 중 45건 선정 → 125건 "탈락" 업데이트                        │
└─────────────────────────────────────────────────────────────────────────┘
    │
    ▼
╚═══════════════════════════════════════════════════════════════════════════╝
    완료
```

### 3.2 공동GP 처리 상세

```
PDF 원본: "A인베스트먼트 / B벤처스"
    │
    ▼
AI 분리 (구분자: /, ,)
    │
    ├─▶ 운용사 1: A인베스트먼트
    │   ├─ 신청현황 1건 생성
    │   └─ 비고: "공동GP"
    │
    └─▶ 운용사 2: B벤처스
        ├─ 신청현황 1건 생성
        └─ 비고: "공동GP"

⚠️ 공동GP 판단 충돌 시:
    pdfplumber: is_joint_gp=true, original_company="A\nB"
    Claude: A(개별), B(개별)

    → 반드시 사용자에게 질문!
    "PDF에서 A, B가 같은 셀에 있는지 확인해주세요."
```

### 3.3 데이터 구조

**운용사 매핑 (operatorMappings)**
```javascript
Map {
  'A인베스트먼트' => {
    id: 'OP0001',        // 기존 ID 또는 PENDING
    name: 'A인베스트먼트',
    isNew: false,
    originalName: 'A인베스트먼트',
    aliasToAdd: null     // 약어에 추가할 표기
  },
  'B벤처스' => {
    id: 'PENDING',
    name: 'B벤처스',
    isNew: true,
    originalName: null
  }
}
```

**enrichedApplicants 배열**
```javascript
[
  {
    index: 1,
    name: 'A인베스트먼트',
    category: '중진 - 루키리그',
    operatorId: 'OP0001',
    status: '선정',           // 또는 '탈락'
    isNew: false,
    isDuplicate: false,
    willSkip: false,
    isJoint: false,
    note: ''
  },
  // ...
]
```

---

## 4. 운용사 유사도 매칭 상세

### 4.1 9단계 유사도 계산 알고리즘

`src/matchers/operator-matcher.js`의 `calculateOperatorSimilarity()`:

| 단계 | 검사 내용 | 점수 | 예시 |
|------|----------|------|------|
| 1 | 정확히 일치 | 1.0 | "KB" = "KB" |
| 2 | 정규화 후 일치 | 0.98 | "(주)KB" = "KB" |
| 3 | 한쪽이 포함 관계 | 0.7 + ratio | "KB" ⊂ "KB인베스트먼트" |
| 4 | 접미사 제거 후 일치 | 0.95 | "KB인베스트먼트" = "KB캐피탈" (접미사만 다름) |
| 5 | 한글 자모 분해 | jamoSim × 0.9 | "케이비" vs "케이베" |
| 6 | 초성 비교 | choSim × 0.7 | "ㅋㅇㅂ" vs "ㅋㅇㅂ" |
| 7 | 영한 약어 양방향 | 0.85 | "KB" ↔ "케이비", "BNK" ↔ "비엔케이" |
| 8 | 부분 문자열 포함 | 0.7 + ratio | "한국투자" ⊂ "한국투자파트너스" |
| 9 | Levenshtein 유사도 | sim × 0.85 | 일반 문자열 유사도 |

### 4.2 자동 판단 규칙

```
┌──────────────────────────────────────────────────────────────────┐
│                    유사도 자동 판단 플로우                          │
└──────────────────────────────────────────────────────────────────┘

유사도 < 60%
    └─▶ 완전 신규 (자동 등록)

60% ≤ 유사도 < 85%
    └─▶ 신규로 처리 (자동 등록)
        이유: 다른 운용사일 가능성 높음

유사도 ≥ 85%
    │
    ├─▶ 핵심명 유사도 < 60%
    │   └─▶ 신규로 처리 (자동)
    │       이유: 접미사만 유사 (A파트너스 vs B파트너스)
    │
    └─▶ 핵심명 유사도 ≥ 60%
        └─▶ ⚠️ 사용자 확인 필요
            이유: 동일 회사 가능성 높음

정확 일치 또는 약어 일치
    └─▶ 기존 운용사 ID 사용 (자동)
```

### 4.3 접미사 정규화 목록

```javascript
// removeCompanySuffix()에서 제거하는 접미사
const suffixes = [
  '인베스트먼트', '벤처스', '파트너스', '캐피탈',
  '자산운용', '투자', '에셋', 'LLC', 'Inc', 'Ltd',
  'Pte', 'Limited', 'Management', 'Company', 'Corp'
];

// isSuffixOnlySimilarity() - 접미사만 유사한지 판단
// 핵심명 60% 미만이면 접미사만 유사한 것으로 판정
```

### 4.4 영문↔한글 약어 매핑

```javascript
const ABBREV_MAP = {
  'kb':  '케이비',
  'ibk': '아이비케이',
  'bnk': '비엔케이',
  'lgc': '엘지씨',
  'sk':  '에스케이',
  'nh':  '엔에이치',
  'sh':  '에스에이치',
  // ... 양방향 매칭 지원
};

// matchesAbbreviation('IBK캐피탈', '아이비케이캐피탈') → true
// matchesAbbreviation('비엔케이투자', 'BNK투자') → true
```

---

## 5. 검토 워크플로우 상세

### 5.1 ReviewSession 클래스

```
┌──────────────────────────────────────────────────────────────────┐
│                    ReviewSession 구조                             │
└──────────────────────────────────────────────────────────────────┘

constructor(reviewData)
    ├─ summary: 요약 정보
    ├─ newOperators: 신규 운용사 목록
    ├─ duplicates: 중복 스킵 목록
    ├─ jointGPs: 공동GP 분리 목록
    └─ applicants: 전체 신청현황 배열

start() → boolean
    ├─ displayReport() → 화면 출력
    ├─ readline 입력 대기
    │   ├─ 'y' → return true (저장 진행)
    │   ├─ 'n' → return false (취소)
    │   ├─ 'e' → editMode() → 다시 대기
    │   ├─ 'r' → displayReport() → 다시 대기
    │   └─ 's' → displaySummary() → 다시 대기
    └─ getFinalApplicants() 반환

editMode()
    ├─ 번호 입력 대기
    └─ editItem(app) 호출

editItem(app)
    ├─ 1. 운용사명 수정 → app.nameEdited = true
    ├─ 2. 출자분야 수정
    ├─ 3. 상태 토글 (선정 ↔ 탈락)
    └─ 4. 삭제 → app.willSkip = true
```

### 5.2 검토 화면 출력 예시

```
╔══════════════════════════════════════════════════════════════════╗
║                        PDF 처리 검토                              ║
╠══════════════════════════════════════════════════════════════════╣

[요약]
  PDF 기재 건수: 171개
  실제 처리 예정: 169개 (공동GP 분리/중복으로 차이)
  선정: 45건 | 탈락: 124건 | 중복 스킵: 2건

──────────────────────────────────────────────────────────────────

[신규 운용사] 5건
  #1  | A투자펀드          | 중진 - 루키리그
  #2  | B벤처캐피탈         | 청년 - 청년창업
  #3  | C파트너스          | 혁신모험 - 창업초기
  ...

──────────────────────────────────────────────────────────────────

[중복 - 저장 안함] 2건
  #45 | 기존운용사A        | 중진 - 루키리그 | 선정
  #78 | 기존운용사B        | 청년 - 청년창업 | 탈락

──────────────────────────────────────────────────────────────────

[공동GP 분리] 3건
  "C인베스트먼트 / D벤처스" → "C인베스트먼트", "D벤처스"
  "E, F파트너스" → "E", "F파트너스"

──────────────────────────────────────────────────────────────────

[신청현황] 169건
  #   | 운용사명          | 출자분야           | 상태  | 플래그
  ─────────────────────────────────────────────────────────────
  1   | A투자펀드         | 중진 - 루키리그     | 선정  | 신규
  2   | B벤처캐피탈        | 청년 - 청년창업     | 탈락  | 신규
  ...
  169 | Z인베스트먼트      | 혁신모험 - 스케일업  | 탈락  | 공동GP

══════════════════════════════════════════════════════════════════
명령어: y(승인) | n(취소) | e(수정) | r(다시보기) | s(요약만)
> _
```

---

## 6. 캐싱 및 배치 최적화 상세

### 6.1 Phase 1: 배치 메서드

```javascript
// ❌ 기존 방식 (비효율)
for (const name of names) {           // 200건
  await sheets.getOrCreateOperator(name);  // 개별 API 호출
}
// 소요시간: 200 × 2초 = 400초 + 할당량 초과 위험

// ✅ Phase 1 방식 (효율)
await sheets.createOperatorsBatch(names);  // 단일 API 호출
// 소요시간: ~5초
```

**배치 메서드 목록:**
| 메서드 | 기능 | API 호출 |
|--------|------|---------|
| `createOperatorsBatch(names)` | 운용사 일괄 생성 | 1회 |
| `createApplicationsBatch(dataList)` | 신청현황 일괄 생성 | 1회 |
| `updateApplicationStatusBatch(updates)` | 상태 일괄 업데이트 | 1회 |
| `updateRejectedStatus(projectId, selectedIds)` | 탈락 일괄 처리 | 1회 |

### 6.2 Phase 2: 캐싱 레이어

```javascript
// GoogleSheetsClient 내부 캐시
class GoogleSheetsClient {
  constructor() {
    this._cache = new Map();        // 시트명 → 데이터
    this._cacheTimestamp = new Map(); // 시트명 → 타임스탬프
    this._cacheTTL = 5 * 60 * 1000;   // 5분 TTL
  }

  async getAllRowsCached(sheetName) {
    const now = Date.now();
    const cached = this._cache.get(sheetName);
    const timestamp = this._cacheTimestamp.get(sheetName);

    // 캐시 유효 시 반환
    if (cached && timestamp && (now - timestamp) < this._cacheTTL) {
      return cached;
    }

    // API 호출 후 캐시 저장
    const data = await this.getAllRows(sheetName);
    this._cache.set(sheetName, data);
    this._cacheTimestamp.set(sheetName, now);
    return data;
  }

  invalidateCache(sheetName) {
    this._cache.delete(sheetName);
    this._cacheTimestamp.delete(sheetName);
  }
}
```

**캐시 효과:**
- 같은 세션에서 '운용사' 시트 3회 조회 → API 1회만 호출
- 신청현황 중복 체크 시 매번 조회 안 함
- 약어 맵 구성 시 추가 API 호출 없음

### 6.3 Phase 3: 트랜잭션 패턴

```
┌─────────────────────────────────────────────────────────────────┐
│           기존 방식 (파싱하면서 즉시 저장)                          │
└─────────────────────────────────────────────────────────────────┘
파싱 → 운용사 저장 → 파싱 → 운용사 저장 → ... → 신청현황 저장

문제:
- 중간 에러 시 롤백 불가
- 사용자 확인 전 데이터 저장됨
- 수정 불가

┌─────────────────────────────────────────────────────────────────┐
│           Phase 3 방식 (검토 후 일괄 저장)                         │
└─────────────────────────────────────────────────────────────────┘
파싱 → 메모리 수집 → 검토 화면 → 승인 → 일괄 저장

장점:
- 승인 전 수정 가능
- 일괄 저장으로 일관성 보장
- 에러 시 롤백 용이
```

### 6.4 Phase 4: 체크포인트 시스템

```javascript
// src/utils/checkpoint.js

class CheckpointManager {
  constructor(sessionId) {
    this.filePath = `./checkpoints/${sessionId}.json`;
    this.state = {
      stage: 'init',
      completedOperators: [],
      completedApplications: [],
      timestamp: null
    };
  }

  async save(stage, data = {}) {
    this.state = { ...this.state, ...data, stage, timestamp: new Date() };
    fs.writeFileSync(this.filePath, JSON.stringify(this.state));
    console.log(`[Checkpoint] ${stage} 저장됨`);
  }

  load() {
    if (fs.existsSync(this.filePath)) {
      this.state = JSON.parse(fs.readFileSync(this.filePath));
      console.log(`[Checkpoint] ${this.state.stage}에서 재개`);
      return this.state;
    }
    return null;
  }

  clear() {
    fs.unlinkSync(this.filePath);
    console.log('[Checkpoint] 삭제됨');
  }
}
```

**체크포인트 저장 시점:**
1. 운용사 배치 생성 완료 후
2. 신청현황 배치 생성 완료 후
3. 약어 업데이트 완료 후
4. 전체 처리 완료 후 (체크포인트 삭제)

### 6.5 API 재시도 래퍼

```javascript
// withRetry() - API 할당량 초과 시 자동 재시도

async function withRetry(fn, options = {}) {
  const { maxRetries = 3, retryDelay = 60000 } = options;

  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      return await fn();
    } catch (error) {
      const isQuotaError =
        error.code === 429 ||
        error.message?.includes('Quota') ||
        error.message?.includes('RATE_LIMIT');

      if (isQuotaError && attempt < maxRetries) {
        console.log(`[Retry] 할당량 초과, ${retryDelay/1000}초 대기...`);
        await sleep(retryDelay);
      } else {
        throw error;
      }
    }
  }
}
```

---

## 7. Google Sheets 데이터 모델

### 7.1 4개 시트 구조

| 시트 | ID 프리픽스 | 주요 컬럼 |
|------|-------------|---------|
| **운용사** | OP | ID, 운용사명, **약어**, 유형, 국가 |
| **출자사업** | PJ | ID, 사업명, 소관, 공고유형, 연도, 차수, **지원파일ID**, **결과파일ID**, 현황, 비고, **확인완료** |
| **신청현황** | AP | ID, 출자사업ID, 운용사ID, 출자분야, 최소결성규모, 모태출자액, 결성예정액, 출자요청액, 통화단위, **상태**, 비고 |
| **파일** | FH | ID, 파일명, **파일번호**, **파일유형**, 파일URL, **처리상태**, 처리일시, 비고, **현황** |

### 7.2 관계 다이어그램

```
┌─────────────┐        ┌─────────────┐        ┌─────────────┐
│   파일 (FH)  │───N:1──│ 출자사업 (PJ)│──1:N───│ 신청현황 (AP)│
└─────────────┘        └─────────────┘        └─────────────┘
                              │                      │
                              │                      │
                              └──────────┬───────────┘
                                         │
                                    ┌────┴────┐
                                    │운용사(OP)│
                                    └─────────┘

관계 설명:
- 파일 N:1 출자사업 (지원파일ID, 결과파일ID로 연결)
- 출자사업 1:N 신청현황 (출자사업ID로 연결)
- 신청현황 N:1 운용사 (운용사ID로 연결)
```

### 7.3 파일-출자사업 연결 예시

**케이스 1: 접수파일 여러 개 + 결과파일 1개**
```
PJ0001: 중기부 2024년 1차 정시
├─ 지원파일ID: "FH0081, FH0119"  (일반 + 지역분야)
└─ 결과파일ID: "FH0001"          (통합 선정결과)
```

**케이스 2: 접수파일 1개 + 결과파일 여러 개**
```
PJ0003: 문화/영화/해양 2024년 1차 정시
├─ 지원파일ID: "FH0082"           (통합 접수현황)
└─ 결과파일ID: "FH0002, FH0003"   (해양 + 문화/영화)
```

---

## 8. Phase 3: 금액 업데이트 (/amount-update)

### 8.1 실행 시점

```
⚠️ /update 완료 후, 선정결과가 처리된 이후에 실행

왜?
├─ 접수현황 PDF에는 금액 정보 없음
├─ 선정결과 PDF에만 금액 정보 존재
└─ 선정된 신청현황에만 금액 필요
```

### 8.2 업데이트 대상 필드 (6개)

| 필드명 | 열 | 설명 | 예시 |
|--------|-----|------|------|
| 최소결성규모 | E | 조합 최소 결성 규모 | 300 (억원) |
| 모태출자액 | F | 모태펀드 출자 금액 | 150 (억원) |
| 결성예정액 | G | 조합 결성 예정 금액 | 500 (억원) |
| 출자요청액 | H | 출자 요청 금액 | 200 (억원) |
| 통화단위 | I | 억원 또는 USD(M) | 억원 |
| 비고 | J | 병합 정보 등 | 병합: 최소 529억 (3사 공유) |

### 8.3 처리 흐름

```
/amount-update 실행
    │
    ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 1: 데이터 준비                                              │
│ ├─ 출자사업 시트 (결과파일ID가 있는 것만)                          │
│ ├─ 파일 시트 (파일번호 → 파일명 매핑)                             │
│ ├─ 운용사 시트 (운용사ID → 운용사명 매핑)                         │
│ └─ 신청현황 시트 (상태='선정'만 필터)                             │
└─────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 2: PDF 분석 및 금액 추출                                     │
│ ├─ downloads/ 폴더에서 결과파일 PDF 찾기                          │
│ ├─ PDF 표에서 금액 정보 추출                                      │
│ └─ 운용사명 + 출자분야로 매칭 키 생성                              │
│                                                                  │
│ PDF 표 컬럼 유형:                                                 │
│ ├─ Type A: 최소결성규모, 모태출자액, 운용사명 (중기부 정시)         │
│ ├─ Type B: 결성예정액, 출자요청액, 운용사명 (문체부, 환경부)        │
│ └─ Type C: 4개 금액 모두 + 운용사명 (일부 사업)                    │
└─────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 3: 병합 셀 처리 (핵심)                                       │
│                                                                  │
│ 예: 재도약 분야 - 3개 펀드가 금액 공유                             │
│ ├─ 원본: 최소결성규모 529억, 모태출자액 300억                      │
│ ├─ 운용사 목록:                                                   │
│ │   1. 동문파트너즈        → 1개 펀드                             │
│ │   2. 어니스트벤처스      → 1개 펀드                             │
│ │   3. 피앤피/파이오니어   → 1개 펀드 (공동GP)                     │
│ │   ─────────────────────────────────                           │
│ │   합계: 3개 펀드 (금액 분할 기준)                                │
│ ├─ 분할: 529÷3=176.33억, 300÷3=100억                            │
│ ├─ 각 운용사에 동일 금액 저장                                     │
│ └─ 비고: "병합: 최소 529억, 모태 300억 (3사 공유)"                 │
│                                                                  │
│ 공동GP 카운팅 규칙:                                               │
│ ├─ PDF 기준: "피앤피/파이오니어" = 1개 펀드 (금액 분할 시)         │
│ └─ DB 저장: 2개 행 (피앤피 1행, 파이오니어 1행, 동일 금액)         │
└─────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 4: 배치 업데이트 (batchUpdate)                               │
│ └─ API 1회 호출로 모든 금액 업데이트                              │
└─────────────────────────────────────────────────────────────────┘
```

---

## 9. Phase 4: 검증 (/verify 커맨드)

### 9.1 검증 흐름

```
/verify {출자사업ID} 실행
    │
    ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 1: 출자사업 메타데이터 로드                                   │
│ └─ 연결된 파일 목록 조회 (지원파일ID, 결과파일ID)                   │
└─────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 2: 각 파일별 검증                                            │
│ ├─ PDF 다운로드 (downloads/ 폴더)                                │
│ ├─ pdfplumber 재파싱                                             │
│ ├─ DB 신청현황 조회 (getApplicationsByFile)                       │
│ └─ PDF ↔ DB 교차 검증                                            │
│                                                                  │
│ 검증 항목:                                                        │
│ ├─ 건수 일치 (PDF 기재 vs DB 저장)                                │
│ ├─ 운용사명 일치 (정확/유사/누락/과잉)                             │
│ ├─ 출자분야 일치                                                  │
│ └─ 선정/탈락 상태 정확성                                          │
└─────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 3: 운용사 약어 교차 검증 (핵심)                                │
│ ├─ 접수파일 표기 vs 선정파일 표기 비교                              │
│ │   예: 접수 "아이비케이캐피탈" ↔ 선정 "IBK캐피탈"                 │
│ └─ 약어 필드에 모든 표기법 포함 여부 확인                           │
└─────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 4: 검증 리포트 출력                                          │
│ ├─ ✅ 정상: 일치 항목                                             │
│ ├─ ⚠️ 경고: 약어 누락 (자동 수정 가능)                             │
│ └─ ❌ 오류: 누락/불일치 (수동 수정 필요)                            │
└─────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 5: 확인완료 필드 업데이트                                     │
│ ├─ 모든 검증 통과 → 'AI확인완료'                                  │
│ ├─ 불일치 + 사용자 승인 → '수동확인완료'                           │
│ └─ 불일치 + 사용자 거부 → '검증실패'                               │
└─────────────────────────────────────────────────────────────────┘
```

### 9.2 검증 리포트 예시

```
┌────────────────────────────────────────────────┐
│  출자사업 검증 리포트: PJ0001                   │
│  중기부 소관 2024년 1차 정시                    │
└────────────────────────────────────────────────┘

📄 접수현황 파일: FH0081
  ✅ PDF 171건 → DB 171건 일치
  ✅ 공동GP 12건 분리 정상
  ⚠️ 운용사 약어 누락 2건

📄 선정결과 파일: FH0001
  ✅ PDF 45건 → DB 선정 45건 일치
  ✅ 탈락 126건 정상

─────────────────────────────────────────────────

[유사 매칭 - 검토 필요]
  PDF: "아이비케이캐피탈"
  Sheet: "IBK벤처투자" (OP0034)
  유사도: 85% - 약어 일치

[PDF에만 있음 - 누락 의심]
  운용사: "신규펀드A"
  분야: 중진 - 루키리그
  파일: FH0081

─────────────────────────────────────────────────
종합 결과:
  ✅ 정상: 5개 항목
  ⚠️ 경고: 2개 항목 (자동 수정 가능)
  ❌ 오류: 0개 항목 (수동 수정 필요)
```

---

## 10. 에러 처리 및 복구

### 10.1 에러 유형별 처리

| 에러 코드 | 원인 | 처리 |
|----------|------|------|
| `DUPLICATE_FILE_LINK` | 파일이 다른 출자사업에 이미 연결 | 프로세스 중단, 수동 확인 필요 |
| `API_QUOTA_EXCEEDED` | 분당 요청 제한 초과 | 1분 대기 후 자동 재시도 (최대 3회) |
| `PDF_PARSE_FAILED` | 비정형 PDF | 해당 파일 스킵, 로그 기록 |
| `CHECKPOINT_RESUME` | 이전 작업 중단됨 | 체크포인트에서 재개 |

### 10.2 체크포인트 복구

```javascript
// 작업 재개 시
const checkpoint = new CheckpointManager(sessionId);
const state = checkpoint.load();

if (state) {
  console.log(`[복구] ${state.stage}에서 재개...`);

  switch (state.stage) {
    case 'operators_created':
      // 운용사 생성 완료 → 신청현황 생성부터
      await createApplications(state.completedOperators);
      break;
    case 'applications_created':
      // 신청현황 생성 완료 → 약어 업데이트부터
      await updateAliases(state.completedApplications);
      break;
    // ...
  }
}
```

---

## 11. 비즈니스 규칙 요약

### 11.1 상태 전이

```
초기 ─────────────▶ 접수 ─────────────▶ 선정 또는 탈락
                    │                      │
                    └─ 접수현황 파일 처리    └─ 선정결과 파일 처리
```

### 11.2 중복 방지

```javascript
// 신청현황 중복 키: 운용사ID|출자분야
const duplicateKey = `${operatorId}|${category}`;

// ✅ 허용: 같은 운용사, 다른 분야
// ❌ 차단: 같은 운용사, 같은 분야, 같은 출자사업
```

### 11.3 현황 계산 원칙

```
⚠️ 반드시 신청현황 테이블에서 계산

❌ 잘못됨: 파일.현황 = "PDF에 50개 기재"
✅ 올바름: 파일.현황 = 신청현황.count() → "총 48개 중 선정 12건"
```

### 11.4 파일유형 판단

```
PDF 내용 우선 원칙:
- "접수현황", "신청현황" → 접수현황
- "선정결과", "심사결과" → 선정결과
- 파일명과 PDF 내용이 다르면 PDF 내용 우선
```

---

## 12. 요약

### 12.1 4단계 파이프라인

```
1. 스크래핑 (npm start)
   └─ KVIC → 다운로드 → Drive/Sheets

2. PDF 처리 (/update)
   └─ 이중 파싱 → 유사도 매칭 → 검토 → 일괄 저장

3. 금액 업데이트 (/amount-update)  ← 선정 완료 후
   └─ 선정결과 PDF → 금액 추출 → 배치 업데이트

4. 검증 (/verify)
   └─ PDF↔DB 교차 검증 → 확인완료 상태 업데이트
```

### 12.2 최적화 적용 현황

| Phase | 최적화 내용 | 효과 |
|-------|-----------|------|
| Phase 1 | 배치 메서드 | API 호출 50배 감소 |
| Phase 2 | 캐싱 레이어 | 중복 조회 60-70% 감소 |
| Phase 3 | 트랜잭션 패턴 | 검토 후 일괄 저장 |
| Phase 4 | 체크포인트 | 에러 복구 가능 |
| Phase 5 | 탈락 업데이트 | 선정 처리 완성 |

### 12.3 핵심 설계 원칙

- **정확도 > 자동화** (사용자 확인 필수 케이스 존재)
- **배치 처리 > 개별 호출** (API 효율성)
- **DB 계산 > 파싱 결과** (데이터 정합성)
- **이중 파싱 > 단일 파싱** (오류 감지)
- **검토 후 저장 > 즉시 저장** (수정 가능성)
