# 데이터 무결성 규칙

데이터 중복 방지 및 파일-출자사업 연결 관리를 위한 규칙들입니다.

## 신청현황 중복 방지

**중복 체크 기준**: 출자사업ID + 운용사ID + 출자분야 조합

- 같은 출자사업에 같은 운용사가 같은 분야로 신청한 경우 → 중복으로 간주, 생성하지 않음
- 같은 운용사가 **다른 분야**에 신청한 경우 → 별도 신청현황으로 등록 (정상)
- PDF 처리 전 기존 신청현황 조회하여 중복 여부 확인 필수

### 주의: 하나의 PDF에 여러 출자사업이 포함된 경우

- 예: `모태펀드_문화__영화__해양__출자사업` → 문화/영화 사업과 해양 사업이 별도
- 각 출자사업별로 신청현황을 분리하여 처리
- 같은 PDF를 다른 출자사업으로 재처리할 때 기존 데이터 중복 생성 주의

### 코드 구현 시 주의사항

- `getExistingApplications()` 반환값의 키는 `운용사ID|출자분야` 형식
- 중복 체크 시 반드시 `운용사ID`와 `출자분야`를 조합한 키로 확인
- ❌ 잘못된 예: `existingApplications.has(operatorId)` (운용사ID만 체크)
- ✅ 올바른 예: `existingApplications.has(\`${operatorId}|${category}\`)` (운용사ID + 출자분야)

## 파일-출자사업 통합 관리 (N:1, 1:N 관계)

하나의 출자사업에 여러 파일이 연결되거나, 하나의 파일에 여러 분야가 포함될 수 있음.

### 케이스 1: 접수파일 여러 개 + 결과파일 1개

**예시**: 중기부 2024년 1차 정시 (일반분야 + 지역분야)

| 파일유형 | 파일ID | 내용 |
|----------|--------|------|
| 접수현황 | FH0081 | 일반분야 (중진, 청년, 혁신모험 등) |
| 접수현황 | FH0119 | 지역분야 (지역창업초기, 라이콘 등) |
| 선정결과 | FH0001 | 일반분야 + 지역분야 통합 |

**처리 방법**:

1. 출자사업 1개로 관리 (PJ0001)
2. 지원파일ID: `FH0081, FH0119` (쉼표로 구분)
3. 결과파일ID: `FH0001`
4. 접수현황 파일 각각 처리 → 신청현황 생성 (상태: 접수)
5. 선정결과 파일 처리 → 모든 분야의 선정/탈락 업데이트
6. 비고: "일반분야 + 지역분야 통합"

### 케이스 2: 접수파일 1개 + 결과파일 여러 개

**예시**: 문화/영화/해양 2024년 1차 정시

| 파일유형 | 파일ID | 내용 |
|----------|--------|------|
| 접수현황 | FH0082 | 문화 + 영화 + 해양 통합 |
| 선정결과 | FH0002 | 해양 분야만 |
| 선정결과 | FH0003 | 문화 + 영화 분야만 |

**처리 방법**:

1. 출자사업 1개로 관리 (PJ0003)
2. 지원파일ID: `FH0082`
3. 결과파일ID: `FH0002, FH0003` (쉼표로 구분)
4. 접수현황 파일 처리 → 모든 분야 신청현황 생성
5. 선정결과 파일 각각 처리 → 해당 분야만 선정/탈락 업데이트
6. 비고: "문화/영화 + 해양 통합"

### 통합 시 주의사항

1. **분야별 선정결과 처리**: 선정결과 파일이 특정 분야만 포함할 경우, 해당 분야 신청현황만 업데이트
2. **현황 계산**: 모든 파일 처리 완료 후 신청현황 테이블에서 재계산
3. **비고 기록**: 통합 사유를 출자사업 비고란에 기록

### 기존 분리된 출자사업 통합 절차

이미 여러 출자사업으로 분리되어 있는 경우 통합:

```javascript
// 1. 신청현황의 출자사업ID 일괄 변경 (PJ0065 → PJ0001)
for (const app of apps.filter(a => a['출자사업ID'] === 'PJ0065')) {
  await sheets.setValues(`신청현황!B${app._rowIndex}`, [['PJ0001']]);
}

// 2. 통합 대상 출자사업의 파일ID 합치기
await sheets.setValues('출자사업!G2', [['FH0081, FH0119']]);  // 지원파일ID

// 3. 삭제할 출자사업 행 삭제 (큰 행 번호부터)
await sheets.deleteRow('출자사업', oldProjectRowIndex);

// 4. 현황 재계산
await sheets.updateProjectStatus('PJ0001');
```

## 출자사업-파일 연결 검증 (자동 에러 발생)

**파일 연결 시 자동 검증**: `updateProjectFileId()` 함수가 자동으로 중복 연결을 감지하고 에러를 발생시킴

```javascript
// 이 함수는 파일이 다른 출자사업에 이미 연결된 경우 에러를 throw함
await sheets.updateProjectFileId(projectId, '선정결과', fileId);
// Error: 파일 중복 연결 오류: FH0044는 이미 PJ0021(문체부...)에 연결됨.
```

**에러 코드**: `DUPLICATE_FILE_LINK`

### 자동 검증 항목

1. 해당 파일이 다른 출자사업에 이미 연결되어 있는지 확인
2. 중복 발견 시 처리 중단 (에러 throw)

### 수동 확인 필요 항목 (자동 검증 불가)

1. **파일명-사업명 일치 확인**
   - 파일명에 포함된 소관(중기부, 문체부 등), 연도, 차수가 출자사업과 일치하는지 확인
   - 예: `중기부_10월_수시_선정결과.pdf` → PJ(중기부, 10월 수시)에만 연결

2. **잘못된 연결 예시** (실제 발생한 오류)
   - FH0044(문체부 선정결과)가 PJ0021(문체부)과 PJ0024(과기정통부) 모두에 연결됨
   - 원인: 파일-사업 매칭 오류

### 검증 체크리스트 (파일 연결 전)

- [ ] 파일의 소관이 출자사업 소관과 일치하는가?
- [ ] 파일의 연도/차수가 출자사업과 일치하는가?
