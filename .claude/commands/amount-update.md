# 선정 신청현황 금액 필드 업데이트

출자사업별 선정결과 PDF를 분석하여 '선정' 상태인 신청현황의 금액 필드를 업데이트합니다.

## 업데이트 대상 필드 (5개)

| 필드명 | 열 | 설명 | 예시 |
|--------|-----|------|------|
| 최소결성규모 | E | 조합 최소 결성 규모 | 300 (억원) |
| 모태출자액 | F | 모태펀드 출자 금액 | 150 (억원) |
| 결성예정액 | G | 조합 결성 예정 금액 | 500 (억원) |
| 출자요청액 | H | 출자 요청 금액 | 200 (억원) |
| **통화단위** | I | 억원 또는 USD(M) | 억원 |

## 금액 형식 규칙

모든 금액은 **억원/M 단위 숫자로 저장** (원화 변환 없음):

- **원화**: 억원 단위 그대로
  - 예: "300억원" → `300`, 통화단위: `억원`
  - 예: "243.35억" → `243.35`, 통화단위: `억원`
- **달러**: M(백만) 단위 그대로
  - 예: "USD 50M" → `50`, 통화단위: `USD(M)`

**통화단위 판단 기준:**

- PDF에 "억원", "억", 숫자만 표기 → `억원`
- PDF에 "USD", "M", "$" 표기 → `USD(M)`
- 해외VC 글로벌 펀드 출자사업 → 기본 `USD(M)`

## 실행 방식

```bash
/amount-update
```

---

## 처리 프로세스

### Step 1: 데이터 준비

1. Google Sheets에서 조회:
   - 출자사업 시트 (결과파일ID가 있는 것만)
   - 파일 시트 (파일번호 → 파일명 매핑)
   - 운용사 시트 (운용사ID → 운용사명 매핑)
   - 신청현황 시트 (선정 상태만)

2. 출자사업별로 선정 신청현황 그룹핑

### Step 2: PDF 분석 및 금액 추출

각 출자사업의 결과파일 PDF를 Read 도구로 분석:

1. `downloads/` 폴더에서 파일번호로 PDF 찾기
2. PDF 표에서 금액 정보 추출:
   - 최소결성규모 (있으면)
   - 모태출자액 (있으면)
   - 결성예정액 (있으면)
   - 출자요청액 (있으면)
3. 운용사명 + 출자분야로 매칭 키 생성

**PDF 표 컬럼 유형:**

| 유형 | 컬럼 구성 | 예시 사업 |
|------|----------|----------|
| A | 최소결성규모, 모태출자액, 운용사명 | 중기부 정시 |
| B | 결성예정액, 출자요청액, 운용사명 | 문체부, 환경부 등 |
| C | 최소결성규모, 모태출자액, 결성예정액, 출자요청액, 운용사명 | 일부 사업 |

### Step 3: 신청현황 매칭 및 배치 데이터 준비

```javascript
// 매칭 로직
for (const app of selectedApplications) {
  const opName = opIdToName.get(app.operatorId);
  const pdfEntry = pdfData.find(p =>
    p.name === opName && p.category === app.category
  );

  if (pdfEntry) {
    batchData.push({
      range: `신청현황!E${app.rowIndex}:I${app.rowIndex}`,
      values: [[
        pdfEntry.minSize || '',      // 최소결성규모
        pdfEntry.motaeAmount || '',  // 모태출자액
        pdfEntry.fundSize || '',     // 결성예정액
        pdfEntry.requestAmount || '',// 출자요청액
        통화단위                      // '억원' 또는 'USD(M)'
      ]]
    });
  }
}
```

**매칭 규칙:**

- 운용사명 + 출자분야가 정확히 일치해야 매칭
- 공동GP는 각각 개별 행으로 매칭
- 분야별 합계만 있는 경우 (여러 운용사 공유): 금액 필드 빈칸 유지

### Step 4: 배치 업데이트

```javascript
// batchUpdate로 한 번에 업데이트 (API 호출 최소화)
await sheets.sheets.spreadsheets.values.batchUpdate({
  spreadsheetId: sheets.spreadsheetId,
  resource: {
    valueInputOption: 'USER_ENTERED',
    data: batchData.map(d => ({
      range: d.range,
      values: d.values
    }))
  }
});
```

---

## 자동 처리 규칙

| 상황 | 처리 방식 |
|------|----------|
| PDF에 금액 정보 없음 | 해당 필드 빈칸 유지 |
| 분야별 합계만 있음 (여러 운용사 공유) | 금액 필드 빈칸, 통화단위만 입력 |
| 운용사 매칭 실패 | 스킵 (로그 출력) |
| 파일 다운로드 안됨 | 스킵 (로그 출력) |
| 이미 금액 입력됨 | 덮어쓰기 |
| 해외VC 글로벌 펀드 | 통화단위: `USD(M)` |

---

## 결과 출력

```text
=== 금액 업데이트 완료 ===

처리 출자사업: N개
업데이트 신청현황: M건
스킵 (매칭 실패): K건

[상세]
- PJ0001 (중기부 2024 1차): 52건 업데이트
- PJ0003 (문화, 영화, 해양 2024 1차): 19건 업데이트
...
```

---

## 주의사항

1. **PDF 표 구조가 사업마다 다름**: 컬럼 구성을 PDF마다 확인 필요
2. **분야명 정확히 매칭**: 시트에 저장된 분야명과 PDF의 분야명이 다를 수 있음
3. **공동GP 분리**: PDF에서 `/`, `,`로 구분된 공동GP는 이미 신청현황에 개별 행으로 저장됨
4. **배치 업데이트 사용**: API 할당량 절약을 위해 batchUpdate 필수
